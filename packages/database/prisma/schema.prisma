// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTH
// ============================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  phone     String?  @unique
  
  // Firebase UID (if using Firebase Auth)
  firebaseUid String? @unique @map("firebase_uid")
  
  // Auth Provider (google.com, facebook.com, password, phone)
  provider String? // Firebase sign-in provider or 'phone' for OTP
  
  // Password (hashed using bcrypt)
  password String? // Hashed password for email/phone login
  
  // Profile
  firstName String?  @map("first_name")
  lastName  String?  @map("last_name")
  avatar    String?
  
  // Role & Status
  role      UserRole @default(USER)
  status    UserStatus @default(ACTIVE)
  
  // Verification
  emailVerified Boolean @default(false) @map("email_verified")
  phoneVerified Boolean @default(false) @map("phone_verified")
  
  // Metadata
  lastLoginAt DateTime? @map("last_login_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")
  
  // Relations
  refreshTokens RefreshToken[]
  notifications Notification[]
  devices       Device[]
  loginHistory  LoginHistory[]
  
  @@map("users")
  @@index([email])
  @@index([firebaseUid])
  @@index([provider])
}

enum UserRole {
  USER
  ADMIN
  MODERATOR
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  DELETED
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String   @map("user_id")
  
  // Device & Session Info
  deviceId    String?       @map("device_id")
  platform    DevicePlatform? 
  ipAddress   String?       @map("ip_address")
  userAgent   String?       @map("user_agent")
  
  expiresAt DateTime @map("expires_at")
  lastUsedAt DateTime @default(now()) @map("last_used_at")
  createdAt DateTime @default(now()) @map("created_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  loginHistory LoginHistory?
  
  @@map("refresh_tokens")
  @@index([userId])
  @@index([token])
  @@index([deviceId])
  @@index([userId, deviceId])
}

model OtpVerification {
  id        String   @id @default(cuid())
  
  // Email or Phone number
  identifier     String
  identifierType OtpIdentifierType
  
  // OTP Code (6 digits)
  otpCode   String @map("otp_code")
  
  // Purpose: REGISTRATION or LOGIN
  purpose   OtpPurpose
  
  // Status
  verified  Boolean  @default(false)
  attempts  Int      @default(0) // Number of failed attempts
  
  // Expiration
  expiresAt  DateTime  @map("expires_at")
  verifiedAt DateTime? @map("verified_at")
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@map("otp_verifications")
  @@index([identifier, purpose])
  @@index([otpCode])
}

enum OtpIdentifierType {
  EMAIL
  PHONE
}

enum OtpPurpose {
  REGISTRATION
  LOGIN
}

// ============================================
// LOGIN HISTORY
// ============================================

model LoginHistory {
  id          String        @id @default(cuid())
  userId      String        @map("user_id")
  
  // Device & Platform Info
  platform    DevicePlatform
  deviceId    String?       @map("device_id")
  deviceModel String?       @map("device_model")
  osVersion   String?       @map("os_version")
  
  // Network Info
  ipAddress   String?       @map("ip_address")
  userAgent   String?       @map("user_agent")
  location    String?       // City, Country (optional, from IP geolocation)
  
  // Login Method
  loginMethod LoginMethod
  
  // Status
  status      LoginStatus   @default(SUCCESS)
  failureReason String?     @map("failure_reason")
  
  // Timestamps
  loginAt     DateTime      @default(now()) @map("login_at")
  
  // Relations
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  refreshToken RefreshToken? @relation(fields: [refreshTokenId], references: [id])
  refreshTokenId String?    @unique @map("refresh_token_id")
  
  @@map("login_history")
  @@index([userId])
  @@index([loginAt])
  @@index([platform])
  @@index([status])
}

enum LoginMethod {
  FIREBASE
  OTP_EMAIL
  OTP_PHONE
  PASSWORD_EMAIL
  PASSWORD_PHONE
}

enum LoginStatus {
  SUCCESS
  FAILED
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id      String             @id @default(cuid())
  userId  String             @map("user_id")
  
  type    NotificationType
  channel NotificationChannel
  
  title   String
  body    String
  data    Json?              // Additional data as JSON
  
  status  NotificationStatus @default(PENDING)
  
  sentAt  DateTime?          @map("sent_at")
  readAt  DateTime?          @map("read_at")
  
  error   String?            // Error message if failed
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("notifications")
  @@index([userId])
  @@index([status])
  @@index([type])
}

enum NotificationType {
  SYSTEM
  MARKETING
  TRANSACTIONAL
  ALERT
}

enum NotificationChannel {
  EMAIL
  SMS
  PUSH
  IN_APP
}

enum NotificationStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  READ
}

// ============================================
// DEVICES (for Push Notifications)
// ============================================

model Device {
  id       String       @id @default(cuid())
  userId   String       @map("user_id")
  
  fcmToken String       @unique @map("fcm_token")
  platform DevicePlatform
  
  deviceId String?      @map("device_id")
  model    String?
  osVersion String?     @map("os_version")
  
  isActive Boolean      @default(true) @map("is_active")
  
  lastUsedAt DateTime   @default(now()) @map("last_used_at")
  createdAt  DateTime   @default(now()) @map("created_at")
  updatedAt  DateTime   @updatedAt @map("updated_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("devices")
  @@index([userId])
  @@index([fcmToken])
}

enum DevicePlatform {
  IOS
  ANDROID
  WEB
}

// ============================================
// ADMIN (Internal Admin Users for Dokifree Admin)
// ============================================

model Admin {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String   // Hashed password using bcrypt
  
  // Profile
  firstName String?  @map("first_name")
  lastName  String?  @map("last_name")
  email     String?  @unique
  avatar    String?
  
  // Role & Status
  role      AdminRole @default(ADMIN)
  status    AdminStatus @default(ACTIVE)
  
  // Metadata
  lastLoginAt DateTime? @map("last_login_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")
  
  @@map("admins")
  @@index([username])
  @@index([email])
  @@index([status])
}

enum AdminRole {
  ADMIN
  MODERATOR
}

enum AdminStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  DELETED
}

// ============================================
// JOBS & QUEUES (for future migration)
// ============================================
// Uncomment when needed for job tracking

// model Job {
//   id          String    @id @default(cuid())
//   name        String
//   data        Json
//   status      JobStatus @default(PENDING)
//   progress    Int       @default(0)
//   result      Json?
//   error       String?
//   attempts    Int       @default(0)
//   maxAttempts Int       @default(3) @map("max_attempts")
//   scheduledAt DateTime? @map("scheduled_at")
//   startedAt   DateTime? @map("started_at")
//   completedAt DateTime? @map("completed_at")
//   createdAt   DateTime  @default(now()) @map("created_at")
//   updatedAt   DateTime  @updatedAt @map("updated_at")
//   
//   @@map("jobs")
//   @@index([status])
//   @@index([name])
// }

// enum JobStatus {
//   PENDING
//   PROCESSING
//   COMPLETED
//   FAILED
//   CANCELLED
// }

