# Dokifree Backend - Cursor AI Rules

## ğŸ¯ Tá»•ng quan Dá»± Ã¡n

ÄÃ¢y lÃ  Next.js backend Ä‘Æ°á»£c thiáº¿t káº¿ theo **Clean Architecture + Domain-Driven Design**, sáºµn sÃ ng migrate sang NestJS. Business logic hoÃ n toÃ n tÃ¡ch biá»‡t khá»i framework Ä‘á»ƒ dá»… dÃ ng migrate vÃ  tÃ¡i sá»­ dá»¥ng.

---

## ğŸ—ï¸ Kiáº¿n trÃºc Layered Architecture

### 1. Presentation Layer (API Routes)
- **Location:** `src/app/api/`
- **Responsibility:** Parse HTTP request, validate input, call service, format response
- **Rules:**
  - âŒ KHÃ”NG BAO GIá»œ viáº¿t business logic trong API routes
  - âŒ KHÃ”NG BAO GIá»œ truy cáº­p database trá»±c tiáº¿p
  - âœ… CHá»ˆ xá»­ lÃ½ HTTP concerns (parse request, format response)
  - âœ… Sá»­ dá»¥ng `validateBody()` vÃ  `validateQuery()` vá»›i Zod schemas
  - âœ… Sá»­ dá»¥ng `successResponse()` vÃ  `errorResponse()` helpers
  - âœ… LuÃ´n thÃªm `@swagger` JSDoc comments cho má»i endpoint

### 2. Application Layer (Services)
- **Location:** `src/server/modules/*/application/`
- **Responsibility:** Business logic, use cases, orchestration
- **Rules:**
  - âŒ KHÃ”NG BAO GIá»œ import tá»« `next/*` packages
  - âŒ KHÃ”NG BAO GIá»œ xá»­ lÃ½ HTTP concerns (request/response)
  - âœ… LUÃ”N lÃ  pure TypeScript (framework-agnostic)
  - âœ… LUÃ”N sá»­ dá»¥ng dependency injection pattern
  - âœ… LUÃ”N throw custom exceptions (tá»« `@/server/common/exceptions`)
  - âœ… Táº¥t cáº£ business logic pháº£i náº±m á»Ÿ Ä‘Ã¢y

### 3. Domain Layer (Entities)
- **Location:** `src/server/modules/*/domain/`
- **Responsibility:** Core business entities, domain logic, business rules
- **Rules:**
  - âŒ KHÃ”NG BAO GIá»œ cÃ³ external dependencies
  - âœ… LUÃ”N lÃ  pure domain logic
  - âœ… LUÃ”N self-contained
  - âœ… Business methods (e.g., `isActive()`, `canLogin()`)

### 4. Infrastructure Layer (Repositories)
- **Location:** `src/server/modules/*/infrastructure/`
- **Responsibility:** Database access, external APIs, file storage
- **Rules:**
  - âœ… LUÃ”N implement interfaces tá»« `@/server/common/interfaces`
  - âœ… LUÃ”N sá»­ dá»¥ng Prisma Client cho database access
  - âœ… LUÃ”N return Domain Entities (khÃ´ng return raw Prisma objects)
  - âœ… Hide implementation details

---

## ğŸ“‚ Cáº¥u trÃºc ThÆ° má»¥c

```
src/
â”œâ”€â”€ app/                      # Next.js App Router (HTTP Layer)
â”‚   â”œâ”€â”€ api/                  # API Routes handlers
â”‚   â”‚   â””â”€â”€ [module]/
â”‚   â”‚       â””â”€â”€ route.ts      # âŒ NO business logic
â”‚   â””â”€â”€ api-docs/             # Swagger UI
â”‚
â”œâ”€â”€ server/                   # Backend logic (Framework-agnostic)
â”‚   â”œâ”€â”€ modules/              # Domain modules
â”‚   â”‚   â””â”€â”€ [module-name]/
â”‚   â”‚       â”œâ”€â”€ domain/       # Entities & business rules
â”‚   â”‚       â”œâ”€â”€ application/  # Services & use cases
â”‚   â”‚       â””â”€â”€ infrastructure/ # Repositories
â”‚   â”‚
â”‚   â”œâ”€â”€ common/
â”‚   â”‚   â”œâ”€â”€ adapters/         # Firebase, Email, SMS adapters
â”‚   â”‚   â”œâ”€â”€ config/           # Environment config
â”‚   â”‚   â”œâ”€â”€ database/         # Prisma client
â”‚   â”‚   â”œâ”€â”€ exceptions/       # Custom exceptions
â”‚   â”‚   â”œâ”€â”€ interfaces/       # Shared interfaces
â”‚   â”‚   â””â”€â”€ swagger/          # Swagger configuration & schemas
â”‚   â”‚
â”‚   â””â”€â”€ http/
â”‚       â”œâ”€â”€ middleware/       # Auth middleware
â”‚       â””â”€â”€ utils/            # Response & validation helpers
â”‚
â””â”€â”€ shared/                   # Code dÃ¹ng chung FE + BE
    â”œâ”€â”€ dtos/                 # Zod schemas + TypeScript types
    â””â”€â”€ types/                # Shared TypeScript types
```

---

## ğŸ”„ Request Flow Pattern

**LUÃ”N tuÃ¢n theo flow nÃ y:**

```
HTTP Request
    â†“
1. API Route (app/api/) - Parse & validate
    â†“
2. Service (server/modules/*/application/) - Business logic
    â†“
3. Repository (server/modules/*/infrastructure/) - Data access
    â†“
4. Prisma - Database query
    â†“
5. Entity (server/modules/*/domain/) - Domain object
    â†“
6. Service returns result
    â†“
7. API Route formats response
    â†“
HTTP Response
```

---

## ğŸ“ NguyÃªn táº¯c PhÃ¡t triá»ƒn

### 1. Module Structure
Khi táº¡o module má»›i, LUÃ”N theo cáº¥u trÃºc:

```
server/modules/[module-name]/
â”œâ”€â”€ domain/
â”‚   â””â”€â”€ [module].entity.ts       # Domain entity vá»›i business methods
â”œâ”€â”€ application/
â”‚   â””â”€â”€ [module].service.ts      # Business logic & use cases
â””â”€â”€ infrastructure/
    â””â”€â”€ [module].repository.ts   # Database access
```

### 2. API Routes Pattern

```typescript
// âœ… ÄÃšNG - API route chá»‰ parse vÃ  delegate
export async function GET(request: NextRequest) {
  try {
    // 1. Parse & validate
    const query = validateQuery(QueryDtoSchema, queryData);
    
    // 2. Call service (business logic á»Ÿ Ä‘Ã¢y)
    const result = await service.doSomething(query);
    
    // 3. Format response
    return successResponse(result.data, 200, result.meta);
  } catch (error) {
    return errorResponse(error);
  }
}

// âŒ SAI - Business logic trong route
export async function GET(request: NextRequest) {
  const users = await prisma.user.findMany(); // âŒ Direct DB access
  if (users.length > 10) { // âŒ Business logic
    // ...
  }
}
```

### 3. Service Pattern

```typescript
// âœ… ÄÃšNG - Pure TypeScript, framework-agnostic
export class UserService {
  constructor(
    private repository: UserRepository,
    private notificationService: NotificationService,
  ) {}

  async createUser(dto: CreateUserDto): Promise<UserEntity> {
    // Business logic here
    const user = await this.repository.create(dto);
    await this.notificationService.sendWelcomeEmail(user);
    return user;
  }
}

// âŒ SAI - Framework dependencies
import { NextRequest } from 'next/server'; // âŒ NO!

export class UserService {
  async createUser(request: NextRequest) { // âŒ NO HTTP in services!
    // ...
  }
}
```

### 4. Repository Pattern

```typescript
// âœ… ÄÃšNG - Return domain entities
export class UserRepository implements IRepository<UserEntity> {
  async findById(id: string): Promise<UserEntity | null> {
    const user = await prisma.user.findUnique({ where: { id } });
    return user ? new UserEntity(user) : null; // âœ… Return entity
  }
}

// âŒ SAI - Return raw Prisma objects
async findById(id: string) {
  return await prisma.user.findUnique({ where: { id } }); // âŒ Raw object
}
```

### 5. DTOs & Validation

```typescript
// âœ… LUÃ”N define DTOs trong shared/dtos/ vá»›i Zod schemas
// shared/dtos/user.dto.ts
import { z } from 'zod';

export const CreateUserDtoSchema = z.object({
  email: z.string().email(),
  firstName: z.string().min(1).optional(),
  lastName: z.string().min(1).optional(),
});

export type CreateUserDto = z.infer<typeof CreateUserDtoSchema>;

// âœ… Sá»­ dá»¥ng trong API routes
const dto = await validateBody(CreateUserDtoSchema, body);
```

### 6. Error Handling

```typescript
// âœ… LUÃ”N sá»­ dá»¥ng custom exceptions
import { NotFoundException, ValidationException } from '@/server/common/exceptions';

// In service:
if (!user) {
  throw new NotFoundException('User not found');
}

// In route:
try {
  // ...
} catch (error) {
  return errorResponse(error); // Helper tá»± Ä‘á»™ng handle AppException
}
```

---

## ğŸ” Authentication Pattern

### Protected Routes
```typescript
// API route vá»›i authentication
export async function GET(request: NextRequest) {
  // 1. Extract & verify token
  const token = request.headers.get('authorization')?.replace('Bearer ', '');
  if (!token) {
    throw new UnauthorizedException('Missing token');
  }
  
  // 2. Verify token
  const payload = await jwtService.verifyAccessToken(token);
  
  // 3. Get current user
  const currentUser = await userService.getUserById(payload.sub);
  
  // 4. Business logic vá»›i user context
  const result = await service.doSomething(currentUser);
  
  return successResponse(result);
}
```

---

## ğŸ“– Swagger Documentation

### LUÃ”N thÃªm @swagger comments cho má»i endpoint

```typescript
/**
 * @swagger
 * /api/users:
 *   get:
 *     tags:
 *       - Users
 *     summary: List users with pagination
 *     parameters:
 *       - in: query
 *         name: page
 *         schema:
 *           type: integer
 *           default: 1
 *       - in: query
 *         name: limit
 *         schema:
 *           type: integer
 *           default: 10
 *     responses:
 *       200:
 *         description: Success
 *         content:
 *           application/json:
 *             schema:
 *               $ref: '#/components/schemas/PaginatedUserResponse'
 */
export async function GET(request: NextRequest) {
  // Implementation
}
```

### Schema Definitions
- Schemas Ä‘Æ°á»£c define trong `src/server/common/swagger/schemas/*.yaml`
- Reuse schemas vá»›i `$ref: '#/components/schemas/SchemaName'`
- Äáº£m báº£o Swagger schema match vá»›i Zod schema

---

## ğŸ—„ï¸ Database (Prisma)

### Quy táº¯c Prisma
1. **Schema:** Chá»‰ edit `prisma/schema.prisma`
2. **Migrations:** LuÃ´n táº¡o migration khi thay Ä‘á»•i schema: `yarn prisma:migrate`
3. **Access:** Chá»‰ access Prisma qua Repositories
4. **Entities:** LuÃ´n convert Prisma objects sang Domain Entities

### Naming Convention
- Table names: `snake_case` (users, refresh_tokens)
- Column names: `snake_case` (first_name, created_at)
- Model names: `PascalCase` (User, RefreshToken)
- Enum names: `PascalCase` (UserRole, UserStatus)

---

## ğŸ”„ Migration Path sang NestJS

**Code Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ migrate dá»… dÃ ng:**

### Next.js â†’ NestJS Mapping
- `Service class` â†’ ThÃªm `@Injectable()` decorator
- `Repository class` â†’ ThÃªm `@Injectable()` decorator
- `API route` â†’ Convert sang `@Controller()` vá»›i decorators
- `Entity` â†’ Giá»¯ nguyÃªn hoáº·c convert sang TypeORM
- `DTOs` â†’ Giá»¯ nguyÃªn hoáº·c thÃªm class-validator decorators
- `@swagger` comments â†’ Convert sang `@Api*()` decorators

### NguyÃªn táº¯c Migration-Ready
- âœ… Business logic KHÃ”NG phá»¥ thuá»™c vÃ o Next.js
- âœ… Services lÃ  pure TypeScript
- âœ… Repositories implement interfaces
- âœ… DTOs vÃ  Types trong shared folder
- âœ… Dependency injection pattern

---

## ğŸ¨ Code Style & Best Practices

### Import Order
```typescript
// 1. External packages
import { NextRequest, NextResponse } from 'next/server';
import { z } from 'zod';

// 2. Internal modules (@/server/*)
import { UserService } from '@/server/modules/users/application/user.service';

// 3. Shared code (@/shared/*)
import { CreateUserDto } from '@/shared/dtos';

// 4. Utils & helpers
import { successResponse, errorResponse } from '@/server/http/utils/response.helper';
```

### Naming Conventions
- **Files:** `kebab-case.ts` (user.service.ts, auth.repository.ts)
- **Classes:** `PascalCase` (UserService, AuthRepository)
- **Functions:** `camelCase` (getUserById, createUser)
- **Constants:** `UPPER_SNAKE_CASE` (JWT_SECRET, MAX_ATTEMPTS)
- **Types/Interfaces:** `PascalCase` (User, CreateUserDto)

### TypeScript
- âœ… LUÃ”N dÃ¹ng strict mode
- âœ… LUÃ”N define return types cho functions
- âœ… LUÃ”N dÃ¹ng explicit types, trÃ¡nh `any`
- âœ… Prefer `interface` cho object shapes, `type` cho unions

---

## ğŸš« KHÃ”NG BAO GIá»œ

1. **KHÃ”NG** import `next/*` trong `src/server/modules/`
2. **KHÃ”NG** viáº¿t business logic trong API routes
3. **KHÃ”NG** access database trá»±c tiáº¿p ngoÃ i repositories
4. **KHÃ”NG** return raw Prisma objects (luÃ´n convert sang Entities)
5. **KHÃ”NG** commit file `.env` (chá»‰ `.env.example`)
6. **KHÃ”NG** skip validation (luÃ´n validate vá»›i Zod)
7. **KHÃ”NG** skip Swagger documentation
8. **KHÃ”NG** táº¡o global singletons (dÃ¹ng dependency injection)

---

## âœ… LUÃ”N LUÃ”N

1. **LUÃ”N** tÃ¡ch business logic vÃ o services
2. **LUÃ”N** validate input vá»›i Zod schemas
3. **LUÃ”N** sá»­ dá»¥ng custom exceptions
4. **LUÃ”N** return Domain Entities tá»« repositories
5. **LUÃ”N** document endpoints vá»›i `@swagger`
6. **LUÃ”N** sá»­ dá»¥ng response helpers (`successResponse`, `errorResponse`)
7. **LUÃ”N** implement repository interface
8. **LUÃ”N** giá»¯ code framework-agnostic trong `server/modules/`
9. **LUÃ”N** test business logic Ä‘á»™c láº­p vá»›i HTTP layer

---

## ğŸ“¦ Dependencies

### Core Stack
- **Framework:** Next.js 14+ (App Router)
- **Database:** PostgreSQL + Prisma ORM
- **Auth:** Firebase Admin SDK + JWT
- **Validation:** Zod
- **Documentation:** Swagger/OpenAPI (swagger-jsdoc)

### Development
- **TypeScript:** Strict mode enabled
- **Linting:** ESLint vá»›i Next.js config
- **Type Checking:** `yarn type-check`

---

## ğŸ§ª Testing Strategy

Khi viáº¿t tests:
- **Unit Tests:** Test services vÃ  entities Ä‘á»™c láº­p
- **Integration Tests:** Test repositories vá»›i test database
- **E2E Tests:** Test API routes vá»›i real dependencies
- Mock dependencies sá»­ dá»¥ng interfaces

---

## ğŸ”§ Environment Variables

LuÃ´n define trong `.env`:
```bash
# Database
DATABASE_URL="postgresql://..."

# JWT
JWT_SECRET="your-secret"
JWT_ACCESS_EXPIRATION="15m"
JWT_REFRESH_EXPIRATION="7d"

# Firebase
FIREBASE_PROJECT_ID="..."
FIREBASE_PRIVATE_KEY="..."
FIREBASE_CLIENT_EMAIL="..."

# Optional Services
SENDGRID_API_KEY="..."
TWILIO_ACCOUNT_SID="..."
```

---

## ğŸ“š Tham kháº£o

Xem thÃªm trong cÃ¡c file:
- `ARCHITECTURE.md` - Chi tiáº¿t kiáº¿n trÃºc
- `MIGRATION_GUIDE.md` - HÆ°á»›ng dáº«n migrate sang NestJS
- `SWAGGER_SETUP_SUCCESS.md` - Setup Swagger
- `LOCAL_SETUP_SUCCESS.md` - Local development setup

---

## ğŸ¯ Má»¥c tiÃªu ChÃ­nh

1. **TÃ¡ch biá»‡t concerns:** HTTP â‰  Business Logic â‰  Data Access
2. **Framework-agnostic:** Business logic khÃ´ng phá»¥ thuá»™c Next.js
3. **Migration-ready:** Dá»… dÃ ng migrate sang NestJS
4. **Clean Architecture:** Dependency flow Ä‘Ãºng hÆ°á»›ng
5. **Type Safety:** Strong typing vá»›i TypeScript
6. **Documentation:** Self-documenting vá»›i Swagger

---

**Nhá»›:** Code Ä‘Æ°á»£c viáº¿t hÃ´m nay pháº£i dá»… dÃ ng migrate sang NestJS ngÃ y mai!

